<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TempleOS - X172 VM</title>
<script src="../emulator/v86.js"></script>
<style>
body {
    margin:0;
    font-family: "Roboto Mono", monospace;
    background:#1e1e1e;
    color:#fff;
    height:100vh;
    display:flex;
    flex-direction:column;
}

/* Topbar */
.topbar {
    height:28px;
    background:#2c2c2c;
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-size:12px;
    padding:0 10px;
    color:#fff;
    position:relative;
    user-select:none;
}

/* Menu items */
.menu {
    display:flex;
    gap:15px;
}

.menu-item {
    cursor:pointer;
    position:relative;
}

.menu-item:hover {
    background: #3b3b3b;
    border-radius:3px;
}

.dropdown {
    display:none;
    position:absolute;
    top:28px;
    left:0;
    background:#3b3b3b;
    border:1px solid #555;
    min-width:140px;
    z-index:1000;
    border-radius:3px;
    flex-direction:column;
}

.dropdown div {
    padding:5px 10px;
    cursor:pointer;
}

.dropdown div:hover {
    background:#505050;
}

/* Show dropdown when active */
.menu-item.active .dropdown {
    display:flex;
}

/* Center time */
#timeDisplay {
    position:absolute;
    left:50%;
    transform:translateX(-50%);
}

/* Loading screen */
#loading-container {
    flex:1;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    background:#1e1e1e;
}

#loading-bar {
    width:300px;
    height:20px;
    border:1px solid #555;
    background:#333;
    border-radius:4px;
    overflow:hidden;
    margin-top:10px;
}

#loading-progress {
    width:0%;
    height:100%;
    background:#3465a4;
}

/* VM canvas */
#screen {
    flex:1;
    width:100%;
    display:none;
}

/* Console */
#console {
    height:120px;
    background:#111;
    color:#0f0;
    font-size:12px;
    overflow-y:auto;
    padding:4px;
    font-family: monospace;
}
</style>
</head>
<body>

<div class="topbar">
    <div class="menu">
        <div class="menu-item" id="fileMenu">File
            <div class="dropdown">
                <div id="saveState">Save State</div>
                <div id="loadState">Load State</div>
                <div id="exitVM">Exit</div>
            </div>
        </div>
        <div class="menu-item" id="editMenu">Edit
            <div class="dropdown">
                <div id="resetVM">Reset VM</div>
            </div>
        </div>
        <div class="menu-item" id="viewMenu">View
            <div class="dropdown">
                <div id="toggleConsole">Toggle Console</div>
                <div id="speed1">1x Speed</div>
                <div id="speed2">2x Speed</div>
                <div id="speed4">4x Speed</div>
            </div>
        </div>
    </div>
    <div id="timeDisplay"></div>
    <div id="vmStatus">TempleOS Loading...</div>
</div>

<div id="loading-container">
    <div>Booting TempleOS...</div>
    <div id="loading-bar"><div id="loading-progress"></div></div>
</div>

<canvas id="screen"></canvas>
<div id="console"></div>

<script>
// Center time display
function updateTime() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2,'0');
    const minutes = now.getMinutes().toString().padStart(2,'0');
    const seconds = now.getSeconds().toString().padStart(2,'0');
    document.getElementById('timeDisplay').textContent = `${hours}:${minutes}:${seconds}`;
}
setInterval(updateTime, 1000);
updateTime();

// Dropdown menu logic (stay open until click elsewhere)
document.querySelectorAll(".menu-item").forEach(item=>{
    item.addEventListener("click", (e)=>{
        e.stopPropagation(); // keep dropdown open
        const isActive = item.classList.contains("active");
        document.querySelectorAll(".menu-item").forEach(i=>i.classList.remove("active"));
        if(!isActive) item.classList.add("active");
    });
});

// Close dropdown when clicking outside
document.addEventListener("click", e=>{
    if(!e.target.closest(".menu-item")) {
        document.querySelectorAll(".menu-item").forEach(i=>i.classList.remove("active"));
    }
});

// Redirect console.log to div
const consoleDiv = document.getElementById("console");
(function(){
    const origLog = console.log;
    console.log = function(...args){
        origLog.apply(console,args);
        const line = document.createElement("div");
        line.textContent = args.join(" ");
        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }
})();

// Loading bar animation
const progressBar = document.getElementById("loading-progress");
let loadPercent = 0;
const loadingInterval = setInterval(()=>{
    loadPercent += Math.random()*4 + 1; // random speed for loading
    if(loadPercent>100) loadPercent=100;
    progressBar.style.width = loadPercent+"%";
},50);

let emulator;
let savedState = null;

window.addEventListener("load", ()=>{
    const canvas = document.getElementById("screen");

    emulator = new V86({
        wasm_path:"../emulator/v86.wasm",
        memory_size:256*1024*1024,
        vga_memory_size:8*1024*1024,
        screen_container: canvas,
        hda: { url:"../isos/TempleOS.ISO" },
        autostart:true,
        serial_container:consoleDiv
    });

    emulator.add_listener("emulator-ready", ()=>{
        clearInterval(loadingInterval);
        progressBar.style.width="100%";
        setTimeout(()=>{
            document.getElementById("loading-container").style.display="none";
            canvas.style.display="block";
            document.getElementById("vmStatus").textContent="TempleOS Running";
            console.log("VM Ready");
        },300); // slight delay for smooth transition
    });

    emulator.add_listener("serial0-output-char",(char)=>{
        console.log(String.fromCharCode(char));
    });
});

// Menu actions
document.getElementById("saveState").onclick = ()=>{
    if(emulator){
        savedState = emulator.save_state();
        console.log("State saved");
    }
};
document.getElementById("loadState").onclick = ()=>{
    if(emulator && savedState){
        emulator.restore_state(savedState);
        console.log("State loaded");
    } else {
        console.log("No saved state available");
    }
};
document.getElementById("exitVM").onclick = ()=> window.close();
document.getElementById("resetVM").onclick = ()=>{
    if(emulator){
        emulator.stop();
        emulator.run();
        console.log("VM reset");
    }
};
document.getElementById("toggleConsole").onclick = ()=>{
    const c = document.getElementById("console");
    c.style.display = (c.style.display==="none")?"block":"none";
};
document.getElementById("speed1").onclick = ()=>{ if(emulator) emulator.set_speed(1); console.log("Speed set to 1x"); }
document.getElementById("speed2").onclick = ()=>{ if(emulator) emulator.set_speed(2); console.log("Speed set to 2x"); }
document.getElementById("speed4").onclick = ()=>{ if(emulator) emulator.set_speed(4); console.log("Speed set to 4x"); }

</script>

</body>
</html>
